{% extends 'citas/base.html' %}
{% load custom_filters %}

{% block title %}Estadísticas - Clínica Dental{% endblock %}

{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block extra_css %}
<style>
    .estadisticas-container {
        width: 100%;
        margin: 0;
        padding: 24px;
        background: #f8fafc;
        box-sizing: border-box;
    }
    
    .main-content {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
    }
    
    body > .app-container > .main-content {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .estadisticas-container > * {
        animation: fadeIn 0.4s ease;
    }
    
    @media (max-width: 1400px) {
        .estadisticas-container {
            padding: 24px 40px;
        }
    }
    
    @media (max-width: 768px) {
        .estadisticas-container {
            padding: 16px 20px;
        }
    }
    
    .main-content {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    /* Header */
    .stats-header {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .btn-pdf-resumen {
        background: linear-gradient(135deg, #14b8a6, #0d9488);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);
        transition: all 0.3s ease;
        font-size: 14px;
    }
    
    .btn-pdf-resumen:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(20, 184, 166, 0.4);
        text-decoration: none;
        color: white;
    }
    
    @media (max-width: 768px) {
        .stats-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .btn-pdf-resumen {
            width: 100%;
            justify-content: center;
        }
    }
    
    .stats-header h1 {
        margin: 0 0 8px 0;
        font-size: 1.75rem;
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .stats-header h1 i {
        color: var(--primary-color);
    }
    
    .stats-header p {
        margin: 0;
        color: #64748b;
        font-size: 0.95rem;
    }
    
    /* Alertas */
    .alert-banner {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border-left: 4px solid #f59e0b;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        color: #78350f;
    }
    
    .alert-banner.danger {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        border-left-color: #ef4444;
        color: #7f1d1d;
    }
    
    .alert-banner i {
        font-size: 1.25rem;
    }
    
    /* KPIs Grid */
    .kpis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }
    
    .kpi-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-left: 4px solid var(--primary-color);
        transition: all 0.3s ease;
    }
    
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }
    
    .kpi-card.success {
        border-left-color: #10b981;
    }
    
    .kpi-card.warning {
        border-left-color: #f59e0b;
    }
    
    .kpi-card.danger {
        border-left-color: #ef4444;
    }
    
    .kpi-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }
    
    .kpi-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }
    
    .kpi-card.success .kpi-icon {
        background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .kpi-card.warning .kpi-icon {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .kpi-card.danger .kpi-icon {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .kpi-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 8px 0;
        line-height: 1;
    }
    
    .kpi-label {
        color: #64748b;
        font-size: 0.875rem;
        margin: 0 0 8px 0;
        font-weight: 500;
    }
    
    .kpi-change {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8125rem;
        margin-top: 8px;
        font-weight: 500;
    }
    
    .kpi-change.positive {
        color: #10b981;
    }
    
    .kpi-change.negative {
        color: #ef4444;
    }
    
    .kpi-change.neutral {
        color: #64748b;
    }
    
    /* Secciones */
    .stats-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 24px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-title i {
        color: var(--primary-color);
    }
    
    /* Gráficos */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .chart-title {
        margin: 0 0 20px 0;
        font-size: 1rem;
        font-weight: 600;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .chart-title i {
        color: var(--primary-color);
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    /* Rankings */
    .ranking-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .ranking-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 14px 0;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .ranking-item:last-child {
        border-bottom: none;
    }
    
    .rank-number {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.875rem;
        flex-shrink: 0;
    }
    
    .rank-number.gold {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
    }
    
    .rank-number.silver {
        background: linear-gradient(135deg, #94a3b8, #64748b);
    }
    
    .rank-number.bronze {
        background: linear-gradient(135deg, #d97706, #b45309);
    }
    
    .ranking-info {
        flex: 1;
    }
    
    .ranking-info h4 {
        margin: 0 0 4px 0;
        color: #1e293b;
        font-size: 0.9375rem;
        font-weight: 600;
    }
    
    .ranking-info p {
        margin: 0;
        color: #64748b;
        font-size: 0.8125rem;
    }
    
    .ranking-value {
        font-size: 1rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    /* Resumen Financiero */
    .financial-summary {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .financial-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .financial-item:last-child {
        border-bottom: none;
        padding-top: 18px;
        margin-top: 8px;
        border-top: 2px solid #e5e7eb;
    }
    
    .financial-label {
        color: #64748b;
        font-size: 0.9375rem;
        font-weight: 500;
    }
    
    .financial-value {
        font-size: 1rem;
        font-weight: 700;
        color: #1e293b;
    }
    
    .financial-value.positive {
        color: #10b981;
    }
    
    .financial-value.negative {
        color: #ef4444;
    }
    
    .financial-value.total {
        font-size: 1.375rem;
    }
    
    @media (max-width: 768px) {
        .estadisticas-container {
            padding: 16px 20px;
        }
        
        .kpis-grid,
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="estadisticas-container">
    <!-- Header -->
    <div class="stats-header">
        <div>
            <h1><i class="fas fa-chart-line"></i> Estadísticas</h1>
            <p>Resumen general de la clínica</p>
        </div>
        <a href="{% url 'exportar_estadisticas_pdf' %}" class="btn-pdf-resumen">
            <i class="fas fa-file-pdf"></i>
            <span>Generar PDF Resumen</span>
        </a>
    </div>
    
    <!-- Alertas -->
    {% if insumos_bajo_stock > 0 %}
    <div class="alert-banner {% if insumos_bajo_stock > 5 %}danger{% endif %}">
        <i class="fas fa-exclamation-triangle"></i>
        <div>
            <strong>{% if insumos_bajo_stock > 5 %}Alerta Crítica:{% else %}Atención:{% endif %}</strong>
            {{ insumos_bajo_stock }} insumo{{ insumos_bajo_stock|pluralize }} con stock bajo. 
            <a href="{% url 'gestor_inventario_unificado' %}?seccion=insumos" style="color: inherit; text-decoration: underline;">Revisar inventario</a>
        </div>
    </div>
    {% endif %}
    
    <!-- KPIs Principales -->
    <div class="kpis-grid">
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
            </div>
            <h2 class="kpi-value">{{ citas_hoy }}</h2>
            <p class="kpi-label">Citas Hoy</p>
            <div class="kpi-change {% if cambio_citas >= 0 %}positive{% else %}negative{% endif %}">
                <i class="fas fa-arrow-{% if cambio_citas >= 0 %}up{% else %}down{% endif %}"></i>
                {{ cambio_citas|floatformat:1 }}% vs mes anterior
            </div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
            </div>
            <h2 class="kpi-value">{{ citas_mes }}</h2>
            <p class="kpi-label">Citas Este Mes</p>
            <div class="kpi-change positive">
                <i class="fas fa-check-circle"></i>
                {{ citas_completadas_mes }} completadas
            </div>
        </div>
        
        <div class="kpi-card success">
            <div class="kpi-header">
                <div class="kpi-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <h2 class="kpi-value">{{ citas_completadas_mes }}</h2>
            <p class="kpi-label">Citas Completadas</p>
            <div class="kpi-change positive">
                <i class="fas fa-calendar-check"></i>
                Este mes
            </div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-icon">
                    <i class="fas fa-users"></i>
                </div>
            </div>
            <h2 class="kpi-value">{{ total_clientes }}</h2>
            <p class="kpi-label">Total Clientes</p>
            <div class="kpi-change {% if cambio_clientes >= 0 %}positive{% else %}neutral{% endif %}">
                <i class="fas fa-user-plus"></i>
                {{ clientes_nuevos_mes }} nuevos este mes
            </div>
        </div>
        
        <div class="kpi-card {% if tasa_ocupacion >= 80 %}success{% elif tasa_ocupacion >= 60 %}warning{% else %}danger{% endif %}">
            <div class="kpi-header">
                <div class="kpi-icon">
                    <i class="fas fa-percentage"></i>
                </div>
            </div>
            <h2 class="kpi-value">{{ tasa_ocupacion|floatformat:1 }}%</h2>
            <p class="kpi-label">Tasa de Ocupación</p>
            <div class="kpi-change neutral">
                <i class="fas fa-info-circle"></i>
                {{ citas_completadas_mes }}/{{ citas_mes }} citas
            </div>
        </div>
        
        <div class="kpi-card {% if tasa_cancelacion <= 10 %}success{% elif tasa_cancelacion <= 15 %}warning{% else %}danger{% endif %}">
            <div class="kpi-header">
                <div class="kpi-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
            </div>
            <h2 class="kpi-value">{{ tasa_cancelacion|floatformat:1 }}%</h2>
            <p class="kpi-label">Tasa de Cancelación</p>
            <div class="kpi-change {% if tasa_cancelacion <= 10 %}positive{% else %}negative{% endif %}">
                <i class="fas fa-{% if tasa_cancelacion <= 10 %}check{% else %}exclamation-triangle{% endif %}"></i>
                {{ citas_canceladas_mes }} canceladas este mes
            </div>
        </div>
    </div>
    
    <!-- Gráficos de Citas -->
    <div class="stats-section">
        <h2 class="section-title">
            <i class="fas fa-chart-bar"></i>
            Análisis de Citas
        </h2>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Distribución por Estado</h3>
                <div class="chart-container">
                    <canvas id="citasEstadoChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title"><i class="fas fa-chart-line"></i> Tendencia Mensual</h3>
                <div class="chart-container">
                    <canvas id="citasMesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Personal -->
    <div class="stats-section">
        <h2 class="section-title">
            <i class="fas fa-user-md"></i>
            Dentistas Más Activos
        </h2>
        
        <div class="ranking-card">
            {% for dentista in dentistas_activos %}
            <div class="ranking-item">
                <div class="rank-number {% if forloop.counter == 1 %}gold{% elif forloop.counter == 2 %}silver{% elif forloop.counter == 3 %}bronze{% endif %}">
                    {{ forloop.counter }}
                </div>
                <div class="ranking-info">
                    <h4>{{ dentista.nombre_completo }}</h4>
                    <p>{{ dentista.especialidad|default:"Odontología General" }}</p>
                </div>
                <div class="ranking-value">{{ dentista.num_citas }} citas</div>
            </div>
            {% empty %}
            <p style="text-align: center; color: #64748b; padding: 40px;">No hay dentistas activos</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function domReady(fn) {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn);
    } else {
        fn();
    }
}

domReady(function() {
    if (typeof Chart !== 'undefined') {
        setTimeout(initCharts, 100);
        return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
    script.onload = function() {
        setTimeout(initCharts, 100);
    };
    script.onerror = function() {
        const script2 = document.createElement('script');
        script2.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
        script2.onload = function() {
            setTimeout(initCharts, 100);
        };
        document.head.appendChild(script2);
    };
    document.head.appendChild(script);
});

function initCharts() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js no está disponible');
        return;
    }

    const turquesaPrimary = '#14b8a6';
    const turquesaLight = '#2dd4bf';

    // Gráfico de Citas por Estado
    const citasEstadoEl = document.getElementById('citasEstadoChart');
    if (citasEstadoEl) {
        const citasEstadoCtx = citasEstadoEl.getContext('2d');
        const estadoData = [
            {{ citas_disponibles|default:0 }}, 
            {{ citas_reservadas|default:0 }}, 
            {{ citas_completadas|default:0 }}, 
            {{ citas_canceladas|default:0 }}
        ];
        new Chart(citasEstadoCtx, {
            type: 'doughnut',
            data: {
                labels: ['Disponibles', 'Reservadas', 'Completadas', 'Canceladas'],
                datasets: [{
                    data: estadoData,
                    backgroundColor: ['#3b82f6', '#10b981', turquesaPrimary, '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    // Gráfico de Citas por Mes
    const citasMesEl = document.getElementById('citasMesChart');
    if (citasMesEl) {
        const citasMesCtx = citasMesEl.getContext('2d');
        const citasMesLabels = [{% for item in citas_por_mes %}'{{ item.mes|escapejs }}'{% if not forloop.last %},{% endif %}{% endfor %}];
        const citasMesData = [{% for item in citas_por_mes %}{{ item.total|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}];
        new Chart(citasMesCtx, {
            type: 'line',
            data: {
                labels: citasMesLabels.length > 0 ? citasMesLabels : ['Mes 1', 'Mes 2', 'Mes 3', 'Mes 4', 'Mes 5', 'Mes 6'],
                datasets: [{
                    label: 'Citas',
                    data: citasMesData.length > 0 ? citasMesData : [0, 0, 0, 0, 0, 0],
                    borderColor: turquesaPrimary,
                    backgroundColor: turquesaLight + '40',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: turquesaPrimary,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Citas: ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    }

}
</script>
{% endblock %}
